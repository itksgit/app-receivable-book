<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>AppPiutang | Invoice</title>

    <!-- Google Font: Source Sans Pro -->
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback"
    />
    <!-- Font Awesome -->
    <link
      rel="stylesheet"
      href="../assets/plugins/fontawesome-free/css/all.min.css"
    />
    <!-- Theme style -->
    <link rel="stylesheet" href="../assets/dist/css/adminlte.min.css" />

    <!-- SweetAlert2 -->
    <link
      rel="stylesheet"
      href="../assets/plugins/sweetalert2-theme-bootstrap-4/bootstrap-4.min.css"
    />

    <!-- DataTables -->
    <link
      rel="stylesheet"
      href="../assets/plugins/datatables-bs4/css/dataTables.bootstrap4.min.css"
    />
    <link
      rel="stylesheet"
      href="../assets/plugins/datatables-responsive/css/responsive.bootstrap4.min.css"
    />
    <link
      rel="stylesheet"
      href="../assets/plugins/datatables-buttons/css/buttons.bootstrap4.min.css"
    />

    <!-- Select2 -->
    <link
      rel="stylesheet"
      href="../assets/plugins/select2/css/select2.min.css"
    />
    <link
      rel="stylesheet"
      href="../assets/plugins/select2-bootstrap4-theme/select2-bootstrap4.min.css"
    />

    <!-- Bootstrap Datepicker CSS -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/css/bootstrap-datepicker.min.css"
    />

    <!-- Toastr -->
    <link rel="stylesheet" href="../assets/plugins/toastr/toastr.min.css" />

    <style>
      .select2-selection__rendered {
        line-height: 38px !important; /* Sesuaikan dengan tinggi input */
      }

      .select2-container .select2-selection--single {
        height: 40px !important; /* Sesuaikan juga tinggi input */
      }

      .select2-selection__arrow {
        height: 38px !important;
      }
    </style>
  </head>
  <body class="hold-transition sidebar-mini sidebar-collapse">
    <div class="wrapper">
      <!-- Navbar -->
      <nav class="main-header navbar navbar-expand navbar-white navbar-light">
        <!-- Left navbar links -->
        <ul class="navbar-nav">
          <li class="nav-item">
            <a class="nav-link" data-widget="pushmenu" href="#" role="button"
              ><i class="fas fa-bars"></i
            ></a>
          </li>
          <li class="nav-item d-none d-sm-inline-block">
            <a href="../index.html" class="nav-link">Dashboard</a>
          </li>
          <li class="nav-item d-none d-sm-inline-block">
            <a href="vendor.html" class="nav-link">Vendor</a>
          </li>
          <li class="nav-item d-none d-sm-inline-block">
            <a href="invoice.html" class="nav-link">Invoice</a>
          </li>
          <li class="nav-item d-none d-sm-inline-block">
            <a href="pelunasan.html" class="nav-link">Pelunasan</a>
          </li>
        </ul>

        <!-- Right navbar links -->
        <ul class="navbar-nav ml-auto">
          <li class="nav-item">
            <a class="nav-link" href="#" id="logoutBtn" title="Logout">
              <i class="fas fa-sign-out-alt"></i>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" data-widget="fullscreen" href="#" role="button">
              <i class="fas fa-expand-arrows-alt"></i>
            </a>
          </li>
        </ul>
      </nav>
      <!-- /.navbar -->

      <!-- Main Sidebar Container -->
      <aside class="main-sidebar sidebar-dark-primary elevation-4">
        <!-- Brand Logo -->
        <a href="#" class="brand-link">
          <img
            src="../assets/dist/img/AdminLTELogo.png"
            alt="Logo"
            class="brand-image img-circle elevation-3"
            style="opacity: 0.8"
          />
          <span class="brand-text font-weight-light">AppPiutang</span>
        </a>

        <!-- Sidebar -->
        <div class="sidebar">
          <!-- (user panel, search, etc. if perlu) -->

          <!-- Sidebar Menu -->
          <nav class="mt-2">
            <ul
              class="nav nav-pills nav-sidebar flex-column"
              data-widget="treeview"
              role="menu"
              data-accordion="false"
            >
              <!-- Dashboard -->
              <li class="nav-item">
                <a href="../index.html" class="nav-link">
                  <i class="nav-icon fas fa-tachometer-alt"></i>
                  <p>Dashboard</p>
                </a>
              </li>

              <!-- Vendor -->
              <li class="nav-item">
                <a href="vendor.html" class="nav-link">
                  <i class="nav-icon fas fa-store"></i>
                  <p>Vendor</p>
                </a>
              </li>

              <!-- Invoice -->
              <li class="nav-item">
                <a href="invoice.html" class="nav-link">
                  <i class="nav-icon fas fa-file-invoice"></i>
                  <p>Invoice</p>
                </a>
              </li>

              <!-- Pelunasan -->
              <li class="nav-item">
                <a href="pelunasan.html" class="nav-link">
                  <i class="nav-icon fas fa-hand-holding-usd"></i>
                  <p>Pelunasan</p>
                </a>
              </li>
            </ul>
          </nav>
          <!-- /.sidebar-menu -->
        </div>
        <!-- /.sidebar -->
      </aside>

      <!-- Content Wrapper. Contains page content -->
      <div class="content-wrapper">
        <!-- Content Header -->
        <section class="content-header">
          <div class="container-fluid">
            <div class="row mb-2">
              <div class="col-sm-6">
                <h1>Invoice</h1>
              </div>
              <div class="col-sm-6">
                <ol class="breadcrumb float-sm-right">
                  <li class="breadcrumb-item">
                    <a href="../index.html">Home</a>
                  </li>
                  <li class="breadcrumb-item active">Invoice</li>
                </ol>
              </div>
            </div>
          </div>
        </section>

        <!-- Main content -->
        <section class="content">
          <!-- Card: Daftar Vendor -->
          <div class="card">
            <div
              class="card-header d-flex justify-content-between align-items-center"
            >
              <h3 class="card-title">Daftar Invoice</h3>
              <!-- Tombol Tambah -->
              <button id="addInvoiceBtn" class="btn btn-primary">
                <i class="fas fa-plus"></i> Tambah
              </button>
            </div>

            <div class="card-body">
              <!-- Tabel Invoice -->
              <h2>Invoice Belum Lunas</h2>
              <table
                id="invoiceBelumLunasTable"
                class="table table-bordered table-striped"
              >
                <thead>
                  <tr>
                    <th>No</th>
                    <th>Nama Vendor</th>
                    <th>Tanggal Inv</th>
                    <th>No Inv</th>
                    <th>Total Inv</th>
                    <th>Due Date</th>
                    <th>Tanggal Lunas</th>
                    <th>Aksi</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>

              <hr class="my-5" />

              <h2>Invoice Sudah Lunas</h2>
              <table
                id="invoiceSudahLunasTable"
                class="table table-bordered table-striped"
              >
                <thead>
                  <tr>
                    <th>No</th>
                    <th>Nama Vendor</th>
                    <th>Tanggal Inv</th>
                    <th>No Inv</th>
                    <th>Total Inv</th>
                    <th>Due Date</th>
                    <th>Tanggal Lunas</th>
                    <th>Aksi</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
            <!-- <<< ini overlay spinner AdminLTE >>> -->
            <div id="loadingOverlay" class="overlay d-none">
              <i class="fas fa-2x fa-sync-alt fa-spin"></i>
            </div>
            <!-- MODAL EXTRA LARGE: Tambah Invoice -->
            <div
              class="modal fade"
              id="modal-add-invoice"
              tabindex="-1"
              aria-labelledby="modalAddInvoiceLabel"
              aria-hidden="true"
            >
              <div class="modal-dialog modal-xl">
                <div class="modal-content">
                  <form id="formAddInvoice">
                    <div class="modal-header">
                      <h5 class="modal-title" id="modalAddInvoiceLabel">
                        Tambah Invoice
                      </h5>
                      <button
                        type="button"
                        class="close"
                        data-dismiss="modal"
                        aria-label="Close"
                      >
                        <span>&times;</span>
                      </button>
                    </div>
                    <div class="modal-body">
                      <div class="form-group">
                        <label for="vendorSelect">Pilih Vendor</label>
                        <select
                          id="vendorSelect"
                          class="form-control select2"
                          name="vendor_id"
                          style="width: 100%"
                        ></select>
                        <small class="text-danger d-none" id="errorVendor"
                          >Vendor wajib dipilih.</small
                        >
                      </div>

                      <div class="form-group">
                        <label for="tanggalInvInput">Tanggal Invoice</label>
                        <div class="input-group date" id="tanggalInvPicker">
                          <div class="input-group-prepend">
                            <span class="input-group-text"
                              ><i class="far fa-calendar-alt"></i
                            ></span>
                          </div>
                          <input
                            type="text"
                            class="form-control"
                            id="tanggalInvInput"
                            name="tanggal_inv"
                            autocomplete="off"
                          />
                        </div>
                        <small class="text-danger d-none" id="errorTanggalInv"
                          >Tanggal invoice wajib diisi.</small
                        >
                      </div>

                      <div class="form-group">
                        <label for="noInvInput">No Invoice</label>
                        <input
                          type="text"
                          class="form-control"
                          id="noInvInput"
                          name="no_inv"
                        />
                        <small class="text-danger d-none" id="errorNoInv"
                          >No Invoice wajib diisi.</small
                        >
                      </div>

                      <div class="form-group">
                        <label for="totalInvInput">Total Invoice</label>
                        <input
                          type="number"
                          class="form-control"
                          id="totalInvInput"
                          name="total_inv"
                          min="0"
                        />
                        <small class="text-danger d-none" id="errorTotalInv"
                          >Total Invoice wajib diisi.</small
                        >
                      </div>

                      <div class="form-group">
                        <label for="dueDateInput">Tanggal Jatuh Tempo</label>
                        <div class="input-group date" id="tanggalInvPicker">
                          <div class="input-group-prepend">
                            <span class="input-group-text"
                              ><i class="far fa-calendar-alt"></i
                            ></span>
                          </div>
                          <input
                            type="text"
                            class="form-control"
                            id="dueDateInput"
                            name="due_date"
                            autocomplete="off"
                          />
                        </div>
                      </div>
                    </div>
                    <div class="modal-footer justify-content-between">
                      <button
                        type="button"
                        class="btn btn-secondary"
                        data-dismiss="modal"
                      >
                        Tutup
                      </button>
                      <button
                        type="submit"
                        class="btn btn-primary"
                        id="btnSaveInvoice"
                      >
                        <span id="btnSaveInvoiceText" class="btn-text"
                          >Simpan</span
                        >
                        <span
                          id="btnSaveInvoiceSpinner"
                          class="spinner-border spinner-border-sm d-none"
                          role="status"
                          aria-hidden="true"
                        ></span>
                      </button>
                    </div>
                  </form>
                </div>
              </div>
            </div>
            <!-- MODAL EXTRA LARGE: Edit Invoice -->
            <div
              class="modal fade"
              id="modal-edit-invoice"
              tabindex="-1"
              aria-labelledby="modalEditInvoiceLabel"
              aria-hidden="true"
            >
              <div class="modal-dialog modal-xl">
                <div class="modal-content">
                  <form id="formEditInvoice">
                    <div class="modal-header">
                      <h5 class="modal-title" id="modalEditInvoiceLabel">
                        Edit Invoice
                      </h5>
                      <button type="button" class="close" data-dismiss="modal">
                        <span>&times;</span>
                      </button>
                    </div>
                    <div class="modal-body row">
                      <!-- Hidden ID -->
                      <input type="hidden" id="editInvoiceId" />

                      <div class="col-md-6 form-group">
                        <label for="editVendorSelect">Pilih Vendor</label>
                        <select
                          id="editVendorSelect"
                          class="form-control select2"
                          style="width: 100%"
                        ></select>
                        <small id="errorEditVendor" class="text-danger d-none"
                          >Vendor wajib dipilih.</small
                        >
                      </div>
                      <div class="col-md-6 form-group">
                        <label for="editNoInvInput">No Invoice</label>
                        <input
                          type="text"
                          id="editNoInvInput"
                          class="form-control"
                        />
                        <small id="errorEditNoInv" class="text-danger d-none"
                          >No invoice wajib diisi.</small
                        >
                      </div>

                      <div class="col-md-6 form-group">
                        <label for="editTanggalInvInput">Tanggal Invoice</label>
                        <div class="input-group date" id="editTanggalInvPicker">
                          <div class="input-group-prepend">
                            <span class="input-group-text"
                              ><i class="far fa-calendar-alt"></i
                            ></span>
                          </div>
                          <input
                            type="text"
                            id="editTanggalInvInput"
                            class="form-control"
                            autocomplete="off"
                          />
                        </div>
                        <small
                          id="errorEditTanggalInv"
                          class="text-danger d-none"
                          >Tanggal wajib diisi.</small
                        >
                      </div>
                      <div class="col-md-6 form-group">
                        <label for="editTotalInvInput">Total Invoice</label>
                        <input
                          type="number"
                          id="editTotalInvInput"
                          class="form-control"
                          min="0"
                        />
                        <small id="errorEditTotalInv" class="text-danger d-none"
                          >Total wajib diisi.</small
                        >
                      </div>

                      <div class="col-md-6 form-group">
                        <label for="editDueDateInput"
                          >Tanggal Jatuh Tempo</label
                        >
                        <div class="input-group date" id="editDueDatePicker">
                          <div class="input-group-prepend">
                            <span class="input-group-text"
                              ><i class="far fa-calendar-alt"></i
                            ></span>
                          </div>
                          <input
                            type="text"
                            id="editDueDateInput"
                            class="form-control"
                            autocomplete="off"
                          />
                        </div>
                        <small id="errorEditDueDate" class="text-danger d-none"
                          >Jatuh tempo wajib diisi.</small
                        >
                      </div>

                      <div class="col-md-6 form-group">
                        <label for="editTanggalLunasInput"
                          >Tanggal Pelunasan</label
                        >
                        <div
                          class="input-group date"
                          id="editTanggalLunasPicker"
                        >
                          <div class="input-group-prepend">
                            <span class="input-group-text"
                              ><i class="far fa-calendar-alt"></i
                            ></span>
                          </div>
                          <input
                            type="text"
                            id="editTanggalLunasInput"
                            class="form-control"
                            autocomplete="off"
                          />
                        </div>
                        <small
                          id="errorEditTanggalLunas"
                          class="text-danger d-none"
                          >Tanggal pelunasan wajib diisi.</small
                        >
                      </div>
                    </div>
                    <div class="modal-footer justify-content-between">
                      <button
                        type="button"
                        class="btn btn-secondary"
                        data-dismiss="modal"
                      >
                        Tutup
                      </button>
                      <button
                        type="submit"
                        class="btn btn-primary"
                        id="btnEditInvoice"
                      >
                        <span
                          class="spinner-border spinner-border-sm d-none"
                          role="status"
                          aria-hidden="true"
                        ></span>
                        <span class="btn-text">Simpan</span>
                      </button>
                    </div>
                  </form>
                </div>
              </div>
            </div>
            <!-- MODAL EXTRA LARGE: Lihat Detail -->
            <div
              class="modal fade"
              id="modal-invoice-details"
              tabindex="-1"
              role="dialog"
              aria-hidden="true"
            >
              <div class="modal-dialog modal-xl" role="document">
                <div class="modal-content">
                  <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">Detail Invoice</h5>
                    <button
                      type="button"
                      class="close text-white"
                      data-dismiss="modal"
                      aria-label="Close"
                    >
                      <span aria-hidden="true">&times;</span>
                    </button>
                  </div>
                  <div class="modal-body">
                    <div class="table-responsive">
                      <table
                        class="table table-bordered table-sm"
                        id="tblInvoiceDetails"
                      >
                        <thead class="thead-light">
                          <tr>
                            <th>No</th>
                            <th>Nama Barang</th>
                            <th>Qty</th>
                            <th>Satuan</th>
                            <th>Harga (@)</th>
                            <th>Diskon (%)</th>
                            <th>Nilai Diskon</th>
                            <th>Pajak (%)</th>
                            <th>Pajak</th>
                            <th>Subtotal</th>
                            <th>Aksi</th>
                          </tr>
                        </thead>
                        <tbody>
                          <tr>
                            <td colspan="10" class="text-center">Memuat...</td>
                          </tr>
                        </tbody>
                      </table>
                    </div>
                  </div>
                  <div class="modal-footer">
                    <button
                      type="button"
                      class="btn btn-secondary"
                      data-dismiss="modal"
                    >
                      Tutup
                    </button>
                  </div>
                </div>
              </div>
            </div>
            <!-- MODAL EXTRA LARGE: Tambah Detail -->
            <div
              class="modal fade"
              id="modal-add-details"
              tabindex="-1"
              aria-labelledby="modalAddDetailsLabel"
              aria-hidden="true"
            >
              <div class="modal-dialog modal-xl">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title" id="modalAddDetailsLabel">
                      Tambah Detail Invoice
                    </h5>
                    <button
                      type="button"
                      class="close"
                      data-dismiss="modal"
                      aria-label="Close"
                    >
                      <span aria-hidden="true">&times;</span>
                    </button>
                  </div>
                  <div class="modal-body" id="form-add-details-container">
                    <!-- Table form akan dirender via JS -->
                  </div>
                  <div class="modal-footer">
                    <button
                      type="button"
                      class="btn btn-secondary"
                      data-dismiss="modal"
                    >
                      Tutup
                    </button>
                    <button
                      type="button"
                      class="btn btn-primary"
                      id="btn-save-details"
                    >
                      Simpan
                    </button>
                  </div>
                </div>
              </div>
            </div>
            <!-- MODAL EXTRA LARGE: Edit Detail -->
            <div
              class="modal fade"
              id="modal-edit-details"
              tabindex="-1"
              aria-labelledby="modalEditDetailsLabel"
              aria-hidden="true"
            >
              <div class="modal-dialog modal-xl">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title" id="modalEditDetailsLabel">
                      Edit Detail
                    </h5>
                    <button
                      type="button"
                      class="close"
                      data-dismiss="modal"
                      aria-label="Close"
                    >
                      <span aria-hidden="true">&times;</span>
                    </button>
                  </div>
                  <div class="modal-body" id="edit-details-container">
                    <!-- Rows form akan di-generate lewat JS -->
                  </div>
                  <div class="modal-footer">
                    <button
                      type="button"
                      class="btn btn-secondary"
                      data-dismiss="modal"
                    >
                      Tutup
                    </button>
                    <button
                      type="button"
                      id="btn-save-edit-details"
                      class="btn btn-primary"
                    >
                      Simpan
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </section>
        <!-- /.content -->
      </div>
      <!-- /.content-wrapper -->

      <!-- Footer -->
      <footer class="main-footer">
        <div class="float-right d-none d-sm-block"><b>Version</b> 1.0.0</div>
        <strong>&copy; 2025 <a href="#">AppPiutang</a>.</strong> All rights
        reserved.
      </footer>
    </div>
    <!-- ./wrapper -->

    <!-- jQuery -->
    <script src="../assets/plugins/jquery/jquery.min.js"></script>
    <!-- Bootstrap 4 -->
    <script src="../assets/plugins/bootstrap/js/bootstrap.bundle.min.js"></script>
    <!-- AdminLTE App -->
    <script src="../assets/dist/js/adminlte.min.js"></script>
    <!-- SweetAlert2 -->
    <script src="../assets/plugins/sweetalert2/sweetalert2.min.js"></script>
    <!-- DataTables  & Plugins -->
    <script src="../assets/plugins/datatables/jquery.dataTables.min.js"></script>
    <script src="../assets/plugins/datatables-bs4/js/dataTables.bootstrap4.min.js"></script>
    <script src="../assets/plugins/datatables-responsive/js/dataTables.responsive.min.js"></script>
    <script src="../assets/plugins/datatables-responsive/js/responsive.bootstrap4.min.js"></script>
    <script src="../assets/plugins/datatables-buttons/js/dataTables.buttons.min.js"></script>
    <script src="../assets/plugins/datatables-buttons/js/buttons.bootstrap4.min.js"></script>
    <script src="../assets/plugins/jszip/jszip.min.js"></script>
    <script src="../assets/plugins/pdfmake/pdfmake.min.js"></script>
    <script src="../assets/plugins/pdfmake/vfs_fonts.js"></script>
    <script src="../assets/plugins/datatables-buttons/js/buttons.html5.min.js"></script>
    <script src="../assets/plugins/datatables-buttons/js/buttons.print.min.js"></script>
    <script src="../assets/plugins/datatables-buttons/js/buttons.colVis.min.js"></script>

    <!-- Select2 -->
    <script src="../assets/plugins/select2/js/select2.full.min.js"></script>

    <!-- Bootstrap Datepicker JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.min.js"></script>

    <!-- Toastr -->
    <script src="../assets/plugins/toastr/toastr.min.js"></script>

    <!-- Script khusus halaman Invoice -->
    <script>
      const token = sessionStorage.getItem("authToken");
      const expiry = sessionStorage.getItem("authExpiry");

      if (!token || !expiry || Date.now() > expiry) {
        sessionStorage.clear();
        window.location.href = "lockscreen.html";
      }

      document
        .getElementById("logoutBtn")
        ?.addEventListener("click", function (e) {
          e.preventDefault();
          if (confirm("Yakin mau keluar?")) {
            sessionStorage.clear();
            window.location.href = "lockscreen.html";
          }
        });

      $(function () {
        //Initialize Select2 Elements
        $(".select2").select2();
      });

      function setActiveMenuForInvoicePage() {
        // hapus active pada semua nav-link dulu
        document
          .querySelectorAll(".nav-link")
          .forEach((a) => a.classList.remove("active"));

        // aktifkan link yang mengarah ke invoice.html
        const anchors = Array.from(document.querySelectorAll("a.nav-link"));
        anchors.forEach((a) => {
          try {
            const href = a.getAttribute("href") || "";
            if (href.endsWith("invoice.html") || href === "invoice.html") {
              a.classList.add("active");
              // jika ada parent li, beri juga class active/menu-open (safe)
              const li = a.closest(".nav-item");
              if (li) li.classList.add("menu-open");
            }
          } catch (e) {
            /* ignore */
          }
        });

        // juga coba beri active pada top navbar (jika ada link yang cocok)
        const topNav = Array.from(document.querySelectorAll(".navbar-nav a"));
        topNav.forEach((a) => {
          const href = a.getAttribute("href") || "";
          if (href.endsWith("invoice.html")) a.classList.add("active");
        });
      }

      let actionQueue = [];
      let refreshTimer = null;
      let refreshDelay = 5000; // 5 detik setelah semua aksi selesai

      function addActionToQueue(description, processFn) {
        const actionId =
          Date.now() + "-" + Math.random().toString(36).substring(2, 7);

        // Tambahkan ke queue
        actionQueue.push({
          id: actionId,
          description,
          status: "pending",
        });

        // Tampilkan toastr untuk pending
        toastr.info(description + " (sedang diproses...)", "Proses", {
          timeOut: 5000,
          extendedTimeOut: 5000,
        });

        // Jalankan proses
        processFn()
          .then(() => updateActionStatus(actionId, "success"))
          .catch(() => updateActionStatus(actionId, "error"));
      }

      function updateActionStatus(id, status) {
        const action = actionQueue.find((a) => a.id === id);
        if (!action) return;

        action.status = status;

        // Update toastr sesuai status
        if (status === "success") {
          toastr.success(action.description + " berhasil", "Selesai");
        } else if (status === "error") {
          toastr.error(action.description + " gagal", "Error");
        }

        checkQueueCompletion();
      }

      function isAnyModalOpen() {
        return document.querySelectorAll(".modal.show").length > 0;
      }

      function checkQueueCompletion() {
        const allDone = actionQueue.every((a) => a.status !== "pending");

        if (allDone) {
          // Jadwalkan refresh
          if (refreshTimer) clearTimeout(refreshTimer);
          refreshTimer = setTimeout(tryRefreshInvoices, refreshDelay);
        }
      }

      function tryRefreshInvoices() {
        if (!isAnyModalOpen()) {
          loadInvoices();
          actionQueue = []; // kosongkan queue setelah refresh
        } else {
          // Tunggu lagi 5 detik jika user masih aktif di modal
          refreshTimer = setTimeout(tryRefreshInvoices, 5000);
        }
      }

      const API_URL =
        "https://script.google.com/macros/s/AKfycbyVnN6XoE6ZYJsAEqLVz5yHOCbGd0Soo425i1W8yu8rxwrWpWcUYEWWp_NwenBW1lIL/exec";

      // Inisialisasi SweetAlert2 Toast
      const Toast = Swal.mixin({
        toast: true,
        position: "top-end",
        showConfirmButton: false,
        timer: 2500,
      });

      // Utility: toggle spinner overlay loading
      function setLoading(isLoading) {
        const overlay = document.getElementById("loadingOverlay");
        overlay.classList.toggle("d-none", !isLoading);
      }

      function formatDate(dateStr) {
        if (!dateStr) return "-";

        const date = new Date(dateStr);
        // Tambahkan 7 jam (7 * 60 * 60 * 1000 ms)
        date.setTime(date.getTime() + 7 * 60 * 60 * 1000);

        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, "0");
        const day = String(date.getDate()).padStart(2, "0");

        return `${year}-${month}-${day}`;
      }

      function smartSortInvoices(invoices) {
        const sorted = [...invoices].sort(
          (a, b) => new Date(a.due_date) - new Date(b.due_date)
        );

        const result = [];
        const seenVendors = new Set();

        for (const invoice of sorted) {
          if (!seenVendors.has(invoice.vendor_id)) {
            const vendorInvoices = sorted.filter(
              (inv) => inv.vendor_id === invoice.vendor_id
            );
            result.push(...vendorInvoices);
            seenVendors.add(invoice.vendor_id);
          }
        }

        return result;
      }

      async function fetchData(table) {
        const cacheBuster = `&_ts=${Date.now()}`; // waktu sekarang sebagai anti-cache
        const res = await fetch(
          `${API_URL}?table=${table}&action=read${cacheBuster}`
        );
        return await res.json();
      }

      let invoiceDataTableBelum, invoiceDataTableSudah;
      let cachedInvoices = []; // Global
      let cachedVendors = []; // Optional, jika vendor juga ingin dicache
      let cachedDetails = []; // cache untuk tabel details

      async function loadInvoices() {
        setLoading(true);
        try {
          const [vendors, invoices, details] = await Promise.all([
            fetchData("vendors"),
            fetchData("invoices"),
            fetchData("details"),
          ]);

          cachedInvoices = invoices;
          cachedVendors = vendors;
          cachedDetails = details;

          const vendorsMap = {};
          vendors.forEach((v) => {
            vendorsMap[v.id] = v.nama;
          });

          // Fungsi bantu: cek mismatch total
          function isTotalMismatch(invoiceId, totalInv) {
            const relatedDetails = cachedDetails.filter(
              (d) => d.invoice_id == invoiceId
            );
            const sumSubtotal = relatedDetails.reduce(
              (sum, det) => sum + (parseFloat(det.subtotal) || 0),
              0
            );
            return Math.round(sumSubtotal) !== parseFloat(totalInv || 0);
          }

          // const belumLunas = smartSortInvoices(
          //   invoices.filter(
          //     (inv) => !inv.tanggal_lunas || inv.tanggal_lunas.trim() === ""
          //   )
          // );

          // const sudahLunas = smartSortInvoices(
          //   invoices.filter(
          //     (inv) => inv.tanggal_lunas && inv.tanggal_lunas.trim() !== ""
          //   )
          // );

          // safe sort descending by id (handles numeric-string ids too)
          function sortByIdDesc(arr) {
            return [...arr].sort((a, b) => {
              const ai = parseInt(a.id, 10);
              const bi = parseInt(b.id, 10);

              if (!isNaN(ai) && !isNaN(bi)) {
                return bi - ai; // numeric compare
              }

              // fallback: localeCompare with numeric option (handles "10" > "2" correctly)
              const sa = (a.id ?? "").toString();
              const sb = (b.id ?? "").toString();
              return sb.localeCompare(sa, undefined, {
                numeric: true,
                sensitivity: "base",
              });
            });
          }

          // helper: apakah invoice sudah lunas (ada tanggal_lunas yang tidak kosong)
          function isPaid(inv) {
            return (
              inv.tanggal_lunas != null &&
              String(inv.tanggal_lunas).trim() !== ""
            );
          }

          // apply
          const sortedInvoices = sortByIdDesc(invoices);

          // pisah
          const belumLunas = sortedInvoices.filter((inv) => !isPaid(inv));
          const sudahLunas = sortedInvoices.filter((inv) => isPaid(inv));

          let noBelum = 1;
          let noSudah = 1;
          const belumLunasRows = [];
          const sudahLunasRows = [];

          const vendorNamaById = (id) => vendorsMap[id] || "Tidak Diketahui";
          const makeRow = (inv, no) => {
            const mismatch = isTotalMismatch(inv.id, inv.total_inv);
            return `
            <tr>
              <td>${no}</td>
              <td>${vendorNamaById(inv.vendor_id)}</td>
              <td>${formatDate(inv.tanggal_inv)}</td>
              <td>${inv.no_inv || "-"}</td>
              <td class="${mismatch ? "text-danger font-weight-bold" : ""}">
                ${
                  inv.total_inv
                    ? parseFloat(inv.total_inv).toLocaleString("id-ID")
                    : "-"
                }
              </td>
              <td>${formatDate(inv.due_date)}</td>
              <td>${formatDate(inv.tanggal_lunas)}</td>
              <td>
                <!-- Tombol Detail Invoice -->
                <button class="btn btn-sm btn-secondary btn-view-details" data-id="${
                  inv.id
                }" title="Lihat Detail">
                  <i class="fas fa-eye"></i>
                </button>
                <button class="btn btn-sm btn-success btn-add-details" data-id="${
                  inv.id
                }" title="Tambah Detail">
                  <i class="fas fa-plus"></i>
                </button>
                <button class="btn btn-sm btn-warning btn-edit-details" data-id="${
                  inv.id
                }" title="Edit Detail">
                  <i class="fas fa-edit"></i>
                </button>

                <!-- Tombol Existing Invoice -->
                <button class="btn btn-sm btn-info btn-edit" data-id="${
                  inv.id
                }" title="Edit Invoice">
                  <i class="fas fa-edit"></i>
                </button>
                <button class="btn btn-sm btn-danger btn-delete" data-id="${
                  inv.id
                }" title="Hapus Invoice">
                  <i class="fas fa-trash"></i>
                </button>
              </td>
            </tr>
          `;
          };

          // Generate rows
          belumLunas.forEach((inv) =>
            belumLunasRows.push(makeRow(inv, noBelum++))
          );
          sudahLunas.forEach((inv) =>
            sudahLunasRows.push(makeRow(inv, noSudah++))
          );

          // ðŸ”¥ Destroy DataTables terlebih dahulu
          if (invoiceDataTableBelum) {
            invoiceDataTableBelum.clear().destroy();
          }
          if (invoiceDataTableSudah) {
            invoiceDataTableSudah.clear().destroy();
          }

          // ðŸ”„ Kosongkan tbody
          document.querySelector("#invoiceBelumLunasTable tbody").innerHTML =
            belumLunasRows.join("");
          document.querySelector("#invoiceSudahLunasTable tbody").innerHTML =
            sudahLunasRows.join("");

          const now = new Date();
          const timestamp = `Dimuat pada: ${now.toLocaleDateString(
            "id-ID"
          )} ${now.toLocaleTimeString("id-ID")}`;

          // âœ… Inisialisasi ulang DataTable: Belum Lunas
          invoiceDataTableBelum = $("#invoiceBelumLunasTable").DataTable({
            destroy: true,
            responsive: true,
            lengthChange: true,
            lengthMenu: [
              [10, 25, 50, 100],
              [10, 25, 50, 100],
            ],
            autoWidth: false,
            order: [],
            buttons: [
              {
                extend: "copy",
                title: "Invoice Belum Lunas",
                messageTop: timestamp,
                exportOptions: { columns: ":not(:last-child)" },
              },
              {
                extend: "excel",
                title: "Invoice Belum Lunas",
                messageTop: timestamp,
                exportOptions: { columns: ":not(:last-child)" },
              },
              {
                extend: "pdf",
                title: "Invoice Belum Lunas",
                messageTop: timestamp,
                exportOptions: { columns: ":not(:last-child)" },
              },
              {
                extend: "print",
                title: "Invoice Belum Lunas",
                messageTop: timestamp,
                exportOptions: { columns: ":not(:last-child)" },
              },
              "colvis",
            ],
          });
          invoiceDataTableBelum
            .buttons()
            .container()
            .appendTo("#invoiceBelumLunasTable_wrapper .col-md-6:eq(0)");

          // âœ… Inisialisasi ulang DataTable: Sudah Lunas
          invoiceDataTableSudah = $("#invoiceSudahLunasTable").DataTable({
            destroy: true,
            responsive: true,
            lengthChange: true,
            lengthMenu: [
              [10, 25, 50, 100],
              [10, 25, 50, 100],
            ],
            autoWidth: false,
            order: [],
            buttons: [
              {
                extend: "copy",
                title: "Invoice Sudah Lunas",
                messageTop: timestamp,
                exportOptions: { columns: ":not(:last-child)" },
              },
              {
                extend: "excel",
                title: "Invoice Sudah Lunas",
                messageTop: timestamp,
                exportOptions: { columns: ":not(:last-child)" },
              },
              {
                extend: "pdf",
                title: "Invoice Sudah Lunas",
                messageTop: timestamp,
                exportOptions: { columns: ":not(:last-child)" },
              },
              {
                extend: "print",
                title: "Invoice Sudah Lunas",
                messageTop: timestamp,
                exportOptions: { columns: ":not(:last-child)" },
              },
              "colvis",
            ],
          });
          invoiceDataTableSudah
            .buttons()
            .container()
            .appendTo("#invoiceSudahLunasTable_wrapper .col-md-6:eq(0)");
        } catch (err) {
          console.error("Gagal memuat data invoice:", err);
        } finally {
          setupInvoiceActions(); // pastikan dipanggil ulang setelah render ulang
          setLoading(false);
        }
      }

      document.addEventListener("DOMContentLoaded", () => {
        loadInvoices();
        setActiveMenuForInvoicePage();
      });

      function setInvoiceLoading(isLoading) {
        const btn = document.querySelector(
          "#formAddInvoice button[type=submit]"
        );
        const spinner = btn.querySelector(".spinner-border");
        const text = btn.querySelector(".btn-text");

        if (isLoading) {
          btn.setAttribute("disabled", "disabled");
          spinner.classList.remove("d-none");
          text.textContent = "Menyimpan...";
        } else {
          btn.removeAttribute("disabled");
          spinner.classList.add("d-none");
          text.textContent = "Simpan";
        }
      }

      function formatDateToYMD(dateStr) {
        if (!dateStr || !dateStr.includes("/")) return ""; // validasi input kosong

        const [dd, mm, yyyy] = dateStr.split("/");
        return `${yyyy}-${mm}-${dd}`;
      }

      async function retryFetch(url, options = {}, retries = 3, delayMs = 500) {
        for (let i = 0; i < retries; i++) {
          try {
            const res = await fetch(url, options);
            if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
            return await res.json();
          } catch (err) {
            if (i === retries - 1) throw err; // terakhir gagal, lempar error
            await new Promise((r) => setTimeout(r, delayMs)); // delay sebelum retry
          }
        }
      }

      async function getNextInvoiceId() {
        const url = `${API_URL}?table=invoices&action=get_next_id`;
        try {
          const data = await retryFetch(url, {}, 3, 500);
          if (!data.next_id || isNaN(data.next_id))
            throw new Error("Invalid next_id");
          return data.next_id;
        } catch (err) {
          console.error(
            "Gagal mendapatkan next invoice ID setelah retry:",
            err
          );
          return Date.now();
        }
      }

      async function getNextDetailId() {
        const url = `${API_URL}?table=details&action=get_next_id`;
        try {
          const data = await retryFetch(url, {}, 3, 500);
          if (!data.next_id || isNaN(data.next_id))
            throw new Error("Invalid next_id");
          return data.next_id;
        } catch (err) {
          console.error(
            "Gagal mendapatkan ID detail berikutnya setelah retry:",
            err
          );
          return Date.now(); // fallback pakai timestamp supaya unik
        }
      }

      // Show modal Tambah Invoice (pakai cachedVendors, tidak fetch lagi)
      document
        .getElementById("addInvoiceBtn")
        .addEventListener("click", async () => {
          // Reset form fields & errors sebelum tampilkan modal
          document.getElementById("formAddInvoice").reset();
          document
            .querySelectorAll("#formAddInvoice small.text-danger")
            .forEach((el) => el.classList.add("d-none"));

          // Tampilkan modal
          $("#modal-add-invoice").modal("show");

          const $vendorSelect = $("#vendorSelect");
          $vendorSelect
            .empty()
            .append('<option value="">-- Pilih Vendor --</option>');

          // Jika cachedVendors terisi, pakai itu. Jika kosong, beri notifikasi / disable simpan.
          if (Array.isArray(cachedVendors) && cachedVendors.length > 0) {
            cachedVendors.forEach((v) => {
              $vendorSelect.append(
                `<option value="${v.id}">${v.nama}</option>`
              );
            });
            // Inisialisasi / re-init select2 dengan parent modal
            $vendorSelect.select2({ dropdownParent: $("#modal-add-invoice") });
            // Pastikan nilai ter-reset (kosong)
            $vendorSelect.val("").trigger("change");

            // Aktifkan tombol simpan jika sebelumnya dinonaktifkan
            document
              .querySelector("#formAddInvoice button[type=submit]")
              .removeAttribute("disabled");
          } else {
            // Jika belum ada cached vendor: tampilkan pesan & disable tombol simpan
            $vendorSelect
              .empty()
              .append(
                '<option value="">-- Tidak ada vendor (muat data terlebih dahulu) --</option>'
              );
            $vendorSelect.select2({ dropdownParent: $("#modal-add-invoice") });
            document
              .querySelector("#formAddInvoice button[type=submit]")
              .setAttribute("disabled", "disabled");

            // Optional: beri toast/swal supaya user tahu
            Toast.fire({
              icon: "info",
              title: "Vendor belum dimuat. Silakan muat ulang halaman.",
            });
          }
        });

      // Submit form tambah invoice
      document
        .getElementById("formAddInvoice")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          // Ambil nilai input
          const vendorId = document.getElementById("vendorSelect").value;
          const noInv = document.getElementById("noInvInput").value.trim();
          const tanggalInv = document
            .getElementById("tanggalInvInput")
            .value.trim();
          const dueDateRaw = document
            .getElementById("dueDateInput")
            .value.trim();
          const totalInv = document
            .getElementById("totalInvInput")
            .value.trim();

          // Validasi
          let hasError = false;
          const showError = (id, msg) => {
            document.getElementById(id).textContent = msg;
            document.getElementById(id).classList.remove("d-none");
            hasError = true;
          };

          if (!vendorId) showError("errorVendor", "Pilih vendor");
          if (!noInv) showError("errorNoInv", "No invoice wajib diisi");
          if (!tanggalInv)
            showError("errorTanggalInv", "Tanggal invoice wajib diisi");
          if (!totalInv) showError("errorTotalInv", "Total wajib diisi");

          if (hasError) return;

          setInvoiceLoading(true);
          // âœ… Tutup modal langsung setelah validasi sukses
          $("#modal-add-invoice").modal("hide");

          const idBaru = await getNextInvoiceId();
          const dueDate = dueDateRaw ? formatDateToYMD(dueDateRaw) : "";

          // Masukkan proses ini ke queue
          addActionToQueue("Menambahkan invoice", async () => {
            try {
              // Kirim ke API
              await fetch(
                `${API_URL}?table=invoices&action=create&id=${idBaru}&vendor_id=${vendorId}&tanggal_inv=${formatDateToYMD(
                  tanggalInv
                )}&no_inv=${encodeURIComponent(
                  noInv
                )}&total_inv=${totalInv}&due_date=${encodeURIComponent(
                  dueDate
                )}`,
                {
                  method: "POST",
                }
              );
            } catch (err) {
              console.warn(
                "POST mungkin gagal karena CORS, lanjutkan validasi manual."
              );
            }

            // âœ… Verifikasi manual
            const res = await fetch(`${API_URL}?table=invoices&action=read`);
            const allInvoices = await res.json();
            const found = allInvoices.find((inv) => inv.id == idBaru);

            if (found) {
              $("#modal-add-invoice").modal("hide");
              return Promise.resolve(); // sukses
            } else {
              return Promise.reject(new Error("Invoice baru tidak ditemukan."));
            }
          });

          setInvoiceLoading(false);
        });

      $(document).ready(() => {
        $("#tanggalInvPicker").datepicker({
          format: "dd/mm/yyyy",
          autoclose: true,
          todayHighlight: true,
        });

        $("#dueDateInput").parent().datepicker({
          format: "dd/mm/yyyy",
          autoclose: true,
          todayHighlight: true,
        });

        // Edit datepickers
        $(
          "#editTanggalInvPicker, #editDueDatePicker, #editTanggalLunasPicker"
        ).datepicker({
          format: "dd/mm/yyyy",
          autoclose: true,
          todayHighlight: true,
        });

        // Edit select2
        $("#editVendorSelect").select2({
          dropdownParent: $("#modal-edit-invoice"),
        });
      });

      /**
       * Konversi output formatDate (yyyy-mm-dd) â†’ dd/mm/yyyy
       * Jika formatDate mengembalikan "-", maka kembalikan string kosong
       */
      function formatDateToDMY(dateStr) {
        const ymd = formatDate(dateStr);
        if (ymd === "-") return "";
        const [yyyy, mm, dd] = ymd.split("-");
        return `${dd}/${mm}/${yyyy}`;
      }

      // Pasang listener Edit & Delete setiap kali tabel di-refresh
      function setupInvoiceActions() {
        // EDIT
        document.querySelectorAll(".btn-edit").forEach((btn) =>
          btn.addEventListener("click", async (e) => {
            const id = e.currentTarget.dataset.id;
            const inv = cachedInvoices.find((x) => x.id == id);
            if (!inv) return;

            // Isi form
            document.getElementById("editInvoiceId").value = inv.id;
            document.getElementById("editNoInvInput").value = inv.no_inv;
            document.getElementById("editTotalInvInput").value = inv.total_inv;
            // Tanggal format dd/mm/yyyy
            document.getElementById("editTanggalInvInput").value =
              formatDateToDMY(inv.tanggal_inv);
            document.getElementById("editDueDateInput").value = formatDateToDMY(
              inv.due_date
            );
            document.getElementById("editTanggalLunasInput").value =
              formatDateToDMY(inv.tanggal_lunas);

            // Select vendor
            const $vs = $("#editVendorSelect");
            $vs.empty().append('<option value="">-- Pilih Vendor --</option>');
            cachedVendors.forEach((v) =>
              $vs.append(`<option value="${v.id}">${v.nama}</option>`)
            );
            $vs.val(inv.vendor_id).trigger("change");

            // Reset error labels
            document
              .querySelectorAll("#formEditInvoice small.text-danger")
              .forEach((el) => el.classList.add("d-none"));
            // Tampilkan modal
            $("#modal-edit-invoice").modal("show");
          })
        );

        // DELETE Invoice dan semua detail terkait (bulk delete + queue)
        document.querySelectorAll(".btn-delete").forEach((btn) =>
          btn.addEventListener("click", async (e) => {
            const id = e.currentTarget.dataset.id;

            const result = await Swal.fire({
              title: "Yakin ingin menghapus invoice ini?",
              text: "Semua detail terkait invoice ini juga akan dihapus.",
              icon: "warning",
              showCancelButton: true,
              confirmButtonText: "Ya, Hapus!",
              cancelButtonText: "Batal",
            });
            if (!result.isConfirmed) return;

            addActionToQueue("Menghapus invoice dan detail", async () => {
              try {
                // 1. Ambil semua detail terbaru
                let allDetails = await fetchData("details");

                // 2. Filter detail yang terkait invoice
                const relatedDetails = allDetails.filter(
                  (d) => d.invoice_id.toString() === id.toString()
                );

                // 3. Bulk delete untuk semua detail terkait (jika ada)
                if (relatedDetails.length > 0) {
                  const detailIds = relatedDetails.map((d) => d.id);
                  await fetch(
                    `${API_URL}?table=details&action=bulk_delete&records=${encodeURIComponent(
                      JSON.stringify(relatedDetails.map((d) => ({ id: d.id })))
                    )}`,
                    {
                      method: "POST",
                    }
                  );
                }

                // 4. Hapus invoice utamanya
                await fetch(
                  `${API_URL}?table=invoices&action=delete&id=${id}`,
                  { method: "POST" }
                );

                // 5. Verifikasi penghapusan
                const allInvoices = await fetchData("invoices");
                allDetails = await fetchData("details");
                cachedDetails = allDetails;

                const invoiceDeleted = !allInvoices.find(
                  (x) => x.id.toString() === id.toString()
                );
                const detailsDeleted = !allDetails.some(
                  (d) => d.invoice_id.toString() === id.toString()
                );

                if (invoiceDeleted && detailsDeleted) {
                  return Promise.resolve();
                } else {
                  return Promise.reject(
                    new Error("Gagal menghapus invoice atau detail")
                  );
                }
              } catch (err) {
                return Promise.reject(err);
              }
            });
          })
        );

        // Submit form Edit Invoice
        document
          .getElementById("formEditInvoice")
          .addEventListener("submit", async (e) => {
            e.preventDefault();

            const btn = document.getElementById("btnEditInvoice");
            const spinner = btn.querySelector(".spinner-border");
            const text = btn.querySelector(".btn-text");

            // Ambil dan validasi
            const id = document.getElementById("editInvoiceId").value;
            const vendorId = $("#editVendorSelect").val();
            const noInv = document
              .getElementById("editNoInvInput")
              .value.trim();
            const tanggal = document
              .getElementById("editTanggalInvInput")
              .value.trim();
            const dueDateRaw = document
              .getElementById("editDueDateInput")
              .value.trim();
            const lunasDateRaw = document
              .getElementById("editTanggalLunasInput")
              .value.trim();
            const total = document
              .getElementById("editTotalInvInput")
              .value.trim();

            let hasError = false;
            const showErr = (id, msg) => {
              document.getElementById(id).textContent = msg;
              document.getElementById(id).classList.remove("d-none");
              hasError = true;
            };

            document
              .querySelectorAll("#formEditInvoice small.text-danger")
              .forEach((el) => el.classList.add("d-none"));

            if (!vendorId) showErr("errorEditVendor", "Vendor wajib dipilih");
            if (!noInv) showErr("errorEditNoInv", "No invoice wajib diisi");
            if (!tanggal) showErr("errorEditTanggalInv", "Tanggal wajib diisi");
            if (!total) showErr("errorEditTotalInv", "Total wajib diisi");
            if (hasError) return;

            // âœ… Tutup modal langsung setelah validasi sukses
            $("#modal-edit-invoice").modal("hide");

            // Masukkan proses ke queue
            addActionToQueue("Memperbarui invoice", async () => {
              const dueDate = dueDateRaw ? formatDateToYMD(dueDateRaw) : "";
              const lunasDate = lunasDateRaw
                ? formatDateToYMD(lunasDateRaw)
                : "";

              // Kirim update
              try {
                await fetch(
                  `${API_URL}?table=invoices&action=update&id=${id}` +
                    `&vendor_id=${vendorId}` +
                    `&no_inv=${encodeURIComponent(noInv)}` +
                    `&tanggal_inv=${formatDateToYMD(tanggal)}` +
                    `&total_inv=${total}` +
                    `&due_date=${encodeURIComponent(dueDate)}` +
                    `&tanggal_lunas=${encodeURIComponent(lunasDate)}`,
                  { method: "POST" }
                );
              } catch {}

              // âœ… Verifikasi manual
              const all = await fetchData("invoices");
              if (all.find((x) => x.id == id)) {
                return Promise.resolve(); // sukses
              } else {
                return Promise.reject(new Error("Gagal memperbarui invoice"));
              }
            });
          });
      }

      // Handler klik tombol Lihat Detail
      $(document).on("click", ".btn-view-details", function () {
        const invoiceId = $(this).data("id");

        // Ambil semua detail yang berelasi
        const detailsForInvoice = cachedDetails.filter(
          (d) => d.invoice_id == invoiceId
        );

        const $tbody = $("#tblInvoiceDetails tbody");
        $tbody.empty();

        let sumQty = 0;
        let sumSubtotal = 0;

        if (detailsForInvoice.length === 0) {
          $tbody.append(
            '<tr><td colspan="10" class="text-center text-muted">Tidak ada detail untuk invoice ini</td></tr>'
          );
        } else {
          detailsForInvoice.forEach((det, idx) => {
            const harga = parseFloat(det.price_per) || 0;
            const qty = parseFloat(det.qty) || 0;
            const diskon = parseFloat(det.discount) || 0;
            const diskonVal = parseFloat(det.discount_val) || 0; // nilai diskon
            const tax_pct = parseFloat(det.tax_pct) || 0;
            const tax_val = parseFloat(det.tax_val) || 0; // pajak
            const subtotal = parseFloat(det.subtotal) || 0;

            sumQty += qty;
            sumSubtotal += subtotal;

            // format untuk angka desimal / rupiah
            const fmtHarga = harga.toLocaleString("id-ID");
            const fmtDiskonVal = diskonVal.toLocaleString("id-ID");
            const fmtSubtotal = subtotal.toLocaleString("id-ID");
            const fmtTaxVal = tax_val.toLocaleString("id-ID");

            // diskon (%) tampilkan koma jika ada desimal
            const fmtDiskonPct =
              diskon % 1 === 0 ? diskon : diskon.toString().replace(".", ",");

            // pajak (%) tampilkan koma jika ada desimal
            const fmtTaxPct =
              diskon % 1 === 0 ? tax_pct : tax_pct.toString().replace(".", ",");

            $tbody.append(`
              <tr>
                <td>${idx + 1}</td>
                <td>${det.nama_barang || "-"}</td>
                <td>${qty}</td>
                <td>${det.unit || "-"}</td>
                <td>${fmtHarga}</td>
                <td>${fmtDiskonPct}</td>
                <td>${fmtDiskonVal}</td>
                <td>${fmtTaxPct}</td>
                <td>${fmtTaxVal}</td>
                <td class="text-right">${fmtSubtotal}</td>
                <td class="text-center">
                  <button class="btn btn-sm btn-danger btn-delete-detail" 
                    data-id="${det.id}" 
                    title="Hapus Detail">
                    <i class="fas fa-trash"></i>
                  </button>
                </td>
              </tr>
            `);
          });

          // Baris total di bawah (total qty + total subtotal)
          $tbody.append(`
            <tr class="font-weight-bold bg-light">
              <td colspan="2" class="text-right">TOTAL</td>
              <td>${sumQty}</td>
              <td colspan="6"></td>
              <td class="text-right">${sumSubtotal.toLocaleString("id-ID")}</td>
              <td></td>
            </tr>
          `);
        }

        $("#modal-invoice-details").modal("show");

        // Hapus detail di dalam modal lihat detail (versi queue)
        $(document).on("click", ".btn-delete-detail", function () {
          const id = $(this).data("id");
          const row = $(this).closest("tr");

          Swal.fire({
            title: "Yakin ingin menghapus detail ini?",
            icon: "warning",
            showCancelButton: true,
            confirmButtonText: "Ya, Hapus!",
            cancelButtonText: "Batal",
          }).then((result) => {
            if (!result.isConfirmed) return;

            // Masukkan ke queue
            addActionToQueue("Menghapus detail", async () => {
              try {
                // 1. Hapus detail di API
                await fetch(`${API_URL}?table=details&action=delete&id=${id}`, {
                  method: "POST",
                });

                // 2. Verifikasi penghapusan
                const allDetails = await fetchData("details");
                cachedDetails = allDetails; // update cache

                if (!allDetails.find((x) => x.id == id)) {
                  // âœ… Sukses, hapus baris dari tabel modal
                  row.remove();

                  // Jika tabel kosong setelah dihapus, tampilkan pesan kosong
                  if ($("#tblInvoiceDetails tbody tr").length === 0) {
                    $("#tblInvoiceDetails tbody").append(
                      '<tr><td colspan="8" class="text-center text-muted">Tidak ada detail untuk invoice ini</td></tr>'
                    );
                  }

                  return Promise.resolve(); // proses sukses
                } else {
                  return Promise.reject(new Error("Gagal menghapus detail"));
                }
              } catch (err) {
                return Promise.reject(err);
              }
            });
          });
        });
      });

      // ===== UTILS =====
      function parseNumber(v) {
        const n = parseFloat(v);
        return isNaN(n) ? 0 : n;
      }

      function calcValue({ base, pctRaw, pct, valInput }) {
        const isManual = valInput.attr("data-manual") === "1";

        if (!isManual) {
          if (pctRaw !== "") {
            const calcVal = base * (pct / 100);
            valInput.val(
              (Math.round((calcVal + Number.EPSILON) * 100) / 100).toFixed(2)
            );
          }
          // Kalau persen kosong â†’ biarkan nilai lama
        }
        return parseNumber(valInput.val());
      }

      // ===== recalcRow (robust untuk <tr> di Add dan .detail-row di Edit) =====
      function recalcRow($row) {
        const qty = parseNumber($row.find(".qty").val());
        const price = parseNumber($row.find(".price").val());
        const baseAmount = qty * price;

        // DISKON
        const discountVal = calcValue({
          base: baseAmount,
          pctRaw: $row.find(".discount_pct").val(),
          pct: parseNumber($row.find(".discount_pct").val()),
          valInput: $row.find(".discount_val"),
        });

        const beforeTax = baseAmount - discountVal;

        // PAJAK
        const taxVal = calcValue({
          base: beforeTax,
          pctRaw: $row.find(".tax_pct").val(),
          pct: parseNumber($row.find(".tax_pct").val()),
          valInput: $row.find(".tax_val"),
        });

        // SUBTOTAL
        const subtotal = beforeTax + taxVal;
        $row
          .find(".subtotal")
          .val(
            (Math.round((subtotal + Number.EPSILON) * 100) / 100).toFixed(2)
          );
      }

      function renderDetailRows($container, details, isEdit = false) {
        $container.empty().append(`
    <div class="table-responsive">
      <table class="table table-bordered table-sm align-middle">
        <thead>
          <tr>
            <th style="width:40px" class="text-center">No</th>
            <th>Nama Barang</th>
            <th style="width:80px">Qty</th>
            <th style="width:90px">Satuan</th>
            <th style="width:140px">Harga (@)</th>
            <th style="width:100px">Diskon (%)</th>
            <th style="width:140px">Nilai Diskon</th>
            <th style="width:100px">Pajak (%)</th>
            <th style="width:120px">Nilai Pajak</th>
            <th style="width:140px">Subtotal</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  `);

        const $tbody = $container.find("tbody");

        details.forEach((det, idx) => {
          const rowIdx = idx + 1; // <-- GUNAKAN 1-based index
          const discount_val =
            det.discount_val || det.discount_val === 0 ? det.discount_val : "";
          const tax_val = det.tax_val || "";
          const tax_pct = det.tax_pct || det.tax_pct === 0 ? det.tax_pct : "";

          $tbody.append(`
      <tr data-row-index="${rowIdx}">
        <td class="text-center align-middle">
          ${rowIdx}
          ${
            isEdit
              ? `<input type="hidden" name="detail_id_${rowIdx}" value="${
                  det.id || ""
                }">`
              : ""
          }
        </td>

        <td><input type="text" class="form-control" name="nama_barang_${rowIdx}" value="${
            det.nama_barang || ""
          }"></td>
        <td><input type="number" step="0.01" class="form-control qty" name="qty_${rowIdx}" value="${
            det.qty || ""
          }"></td>
        <td><input type="text" class="form-control" name="unit_${rowIdx}" value="${
            det.unit || ""
          }"></td>
        <td><input type="number" step="0.01" class="form-control price" name="price_per_${rowIdx}" value="${
            det.price_per || ""
          }"></td>
        <td><input type="number" step="0.01" class="form-control discount_pct" name="discount_pct_${rowIdx}" value="${
            det.discount || ""
          }"></td>
        <td><input type="number" step="0.01" class="form-control discount_val" name="discount_val_${rowIdx}" value="${discount_val}"></td>
        <td><input type="number" step="0.01" class="form-control tax_pct" name="tax_pct_${rowIdx}" value="${tax_pct}"></td>
        <td><input type="number" step="0.01" class="form-control tax_val" name="tax_val_${rowIdx}" value="${tax_val}"></td>
        <td><input type="number" step="0.01" class="form-control subtotal" name="subtotal_${rowIdx}" value="${
            det.subtotal || ""
          }"></td>
      </tr>
    `);
        });
      }

      $(document).on("click", ".btn-add-details", function () {
        const invoiceId = $(this).data("id");
        $("#btn-save-details").data("invoice-id", invoiceId);

        // Misalnya default 5 baris kosong
        const emptyDetails = Array.from({ length: 15 }, () => ({
          nama_barang: "",
          qty: "",
          unit: "",
          price_per: "",
          discount: "",
          discount_val: "",
          tax_pct: "",
          tax_val: "",
          subtotal: "",
        }));

        renderDetailRows($("#form-add-details-container"), emptyDetails, false);

        $("#modal-add-details").modal("show");
      });

      $(document).on("click", ".btn-edit-details", function () {
        const invoiceId = $(this).data("id");
        const detailsForInvoice = cachedDetails.filter(
          (d) => d.invoice_id == invoiceId
        );

        $("#btn-save-edit-details").data("invoice-id", invoiceId);

        renderDetailRows($("#edit-details-container"), detailsForInvoice, true);

        $("#modal-edit-details").modal("show");
      });

      $(document).on("input change", ".table input", function () {
        const $row = $(this).closest("tr");

        // Diskon manual
        if ($(this).hasClass("discount_val")) {
          $(this).attr("data-manual", "1");
        }
        if ($(this).hasClass("discount_pct")) {
          $row.find(".discount_val").removeAttr("data-manual");
        }

        // Pajak manual
        if ($(this).hasClass("tax_val")) {
          $(this).attr("data-manual", "1");
        }
        if ($(this).hasClass("tax_pct")) {
          $row.find(".tax_val").removeAttr("data-manual");
        }

        recalcRow($row);
      });

      // Helper: ambil value field dari $row dengan beberapa prefix kemungkinan
      function getRowVal($row, prefixes) {
        for (let p of prefixes) {
          const $f = $row.find(`[name^="${p}"]`);
          if ($f.length) return $f.val();
        }
        return "";
      }

      // Handler Save Add Details (legacy indexed mode only; robust & fixed id assignment)
      $("#btn-save-details").on("click", function () {
        const invoiceId = $(this).data("invoice-id");
        $("#modal-add-details").modal("hide");

        addActionToQueue("Menambahkan detail", async () => {
          let createRecords = [];

          // =================== build createRecords (legacy indexed) ===================
          let maxIdx = 0;
          $("#form-add-details, #form-add-details-container")
            .find("input[name]")
            .each(function () {
              const nm = $(this).attr("name");
              const m = nm && nm.match(/_(\d+)$/);
              if (m) {
                const idx = parseInt(m[1], 10);
                if (idx > maxIdx) maxIdx = idx;
              }
            });

          if (maxIdx > 0) {
            for (let i = 1; i <= maxIdx; i++) {
              const nama_barang =
                $(`[name="nama_barang_${i}"]`).val() ||
                $(`[name="nama_barang_${i}"]`).text(); // fallback
              const qty = $(`[name="qty_${i}"]`).val();
              const unit = $(`[name="unit_${i}"]`).val();
              const price_per =
                $(`[name="price_per_${i}"]`).val() ||
                $(`[name="harga_${i}"]`).val() ||
                $(`[name="price_${i}"]`).val();
              const discount =
                $(`[name="discount_pct_${i}"]`).val() ||
                $(`[name="diskon_${i}"]`).val() ||
                "";
              const discount_val = $(`[name="discount_val_${i}"]`).val() || "";
              const tax_pct = $(`[name="tax_pct_${i}"]`).val() || "";
              const tax_val =
                $(`[name="tax_val_${i}"]`).val() ||
                $(`[name="tax_${i}"]`).val() ||
                "";
              const subtotal = $(`[name="subtotal_${i}"]`).val() || "";

              if (!nama_barang && !qty && !price_per) continue; // skip kosong

              createRecords.push({
                id: null,
                invoice_id: invoiceId,
                nama_barang: nama_barang || "",
                qty: qty || "",
                unit: unit || "",
                price_per: price_per || "",
                discount: discount || "",
                discount_val: discount_val || "",
                tax_pct: tax_pct || "",
                tax_val: tax_val || "",
                subtotal: subtotal || "",
              });
            }
          }

          if (createRecords.length === 0) {
            Toast.fire({
              icon: "info",
              title: "Tidak ada detail yang ditambahkan",
            });
            return;
          }

          // =================== assign ids once (increment locally) ===================
          let startIdRaw;
          try {
            startIdRaw = await getNextDetailId(); // ambil sekali saja
          } catch (err) {
            console.warn("getNextDetailId() gagal:", err);
            startIdRaw = null;
          }

          let startId = parseInt(startIdRaw, 10);
          if (!Number.isFinite(startId)) {
            // fallback: gunakan timestamp supaya unik
            startId = Date.now();
            console.warn("Fallback startId dipakai:", startId);
          }

          for (let i = 0; i < createRecords.length; i++) {
            createRecords[i].id = startId + i;
          }

          try {
            const url = `${API_URL}?table=details&action=bulk_create&records=${encodeURIComponent(
              JSON.stringify(createRecords)
            )}`;

            await fetch(url, { method: "POST" });

            const allDetails = await fetchData("details");
            cachedDetails = allDetails;

            let anySaved = createRecords.some((r) =>
              allDetails.find((d) => d.id == r.id)
            );

            if (anySaved) {
              Toast.fire({
                icon: "success",
                title: "Detail berhasil ditambahkan",
              });
            } else {
              Toast.fire({ icon: "error", title: "Gagal menambahkan detail" });
            }
          } catch (err) {
            console.error("Gagal bulk create:", err);
            Toast.fire({ icon: "error", title: "Gagal melakukan bulk create" });
          }
        });
      });

      // Simpan Edit Detail (bulk_update)
      $("#btn-save-edit-details").on("click", function () {
        const invoiceId = $(this).data("invoice-id");
        const $container = $("#edit-details-container");

        $("#modal-edit-details").modal("hide");

        addActionToQueue("Mengedit detail", async () => {
          let updateRecords = [];

          $container.find("tbody tr").each(function (i) {
            const $row = $(this);

            const detailId = $row.find('[name^="detail_id"]').val();
            const nama_barang = $row.find('[name^="nama_barang"]').val();
            const qty = $row.find('[name^="qty"]').val();
            const unit = $row.find('[name^="unit"]').val();
            const price_per = $row.find('[name^="price_per"]').val();
            const discount = $row.find('[name^="discount_pct"]').val();
            const discount_val = $row.find('[name^="discount_val"]').val();
            const tax_pct = $row.find('[name^="tax_pct"]').val();
            const tax_val = $row.find('[name^="tax_val"]').val();
            const subtotal = $row.find('[name^="subtotal"]').val();

            if (!nama_barang && !qty && !price_per) return;

            updateRecords.push({
              id: detailId,
              invoice_id: invoiceId,
              nama_barang: nama_barang || "",
              qty: qty || "",
              unit: unit || "",
              price_per: price_per || "",
              discount: discount || "",
              discount_val: discount_val || "",
              tax_pct: tax_pct || "",
              tax_val: tax_val || "",
              subtotal: subtotal || "",
            });
          });

          if (updateRecords.length === 0) {
            Toast.fire({
              icon: "info",
              title: "Tidak ada perubahan yang disimpan",
            });
            return;
          }

          try {
            const url = `${API_URL}?table=details&action=bulk_update&records=${encodeURIComponent(
              JSON.stringify(updateRecords)
            )}`;
            await fetch(url, { method: "POST" });

            const allDetails = await fetchData("details");
            cachedDetails = allDetails;
            const updated = allDetails.filter((d) => d.invoice_id == invoiceId);

            if (updated.length > 0) {
              Toast.fire({
                icon: "success",
                title: "Detail berhasil diperbarui",
              });
            } else {
              Toast.fire({ icon: "error", title: "Gagal memperbarui detail" });
            }
          } catch (err) {
            console.error("Gagal bulk update:", err);
            Toast.fire({ icon: "error", title: "Gagal melakukan bulk update" });
          }
        });
      });
    </script>
  </body>
</html>
