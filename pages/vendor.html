<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>AppPiutang | Vendor</title>

    <!-- Google Font: Source Sans Pro -->
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback"
    />
    <!-- Font Awesome -->
    <link
      rel="stylesheet"
      href="../assets/plugins/fontawesome-free/css/all.min.css"
    />
    <!-- Theme style -->
    <link rel="stylesheet" href="../assets/dist/css/adminlte.min.css" />

    <!-- SweetAlert2 -->
    <link
      rel="stylesheet"
      href="../assets/plugins/sweetalert2-theme-bootstrap-4/bootstrap-4.min.css"
    />

    <!-- Toastr (untuk queue notifications) -->
    <link rel="stylesheet" href="../assets/plugins/toastr/toastr.min.css" />

    <!-- DataTables -->
    <link
      rel="stylesheet"
      href="../assets/plugins/datatables-bs4/css/dataTables.bootstrap4.min.css"
    />
    <link
      rel="stylesheet"
      href="../assets/plugins/datatables-responsive/css/responsive.bootstrap4.min.css"
    />
    <link
      rel="stylesheet"
      href="../assets/plugins/datatables-buttons/css/buttons.bootstrap4.min.css"
    />

    <style>
      /* Minor styling untuk update dropdown agar lebih friendly */
      .update-item .version {
        font-weight: 700;
      }
      .update-item .muted {
        color: #6c757d;
        font-size: 0.85rem;
      }
      /* Batasi tinggi dropdown agar scrollable pada mobile; jika melebihi, user disarankan buka modal */
      .update-dropdown {
        max-height: 260px;
        overflow-y: auto;
        min-width: 360px;
      }
      /* Agar enak dibaca di mobile */
      @media (max-width: 575px) {
        .update-dropdown {
          min-width: 260px;
        }
      }
      /* animasi "fade-in" ringan untuk isi modal */
      .fade-in-250 {
        animation: fadeIn250 0.25s ease-in-out;
      }
      @keyframes fadeIn250 {
        from {
          opacity: 0;
          transform: translateY(-6px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
    </style>
  </head>
  <body class="hold-transition sidebar-mini sidebar-collapse">
    <div class="wrapper">
      <!-- Navbar -->
      <nav class="main-header navbar navbar-expand navbar-white navbar-light">
        <!-- Left navbar links -->
        <ul class="navbar-nav">
          <li class="nav-item">
            <a class="nav-link" data-widget="pushmenu" href="#" role="button"
              ><i class="fas fa-bars"></i
            ></a>
          </li>
          <li class="nav-item d-none d-sm-inline-block">
            <a href="../index.html" class="nav-link">Dashboard</a>
          </li>
          <li class="nav-item d-none d-sm-inline-block">
            <a href="vendor.html" class="nav-link">Vendor</a>
          </li>
          <li class="nav-item d-none d-sm-inline-block">
            <a href="invoice.html" class="nav-link">Invoice</a>
          </li>
          <li class="nav-item d-none d-sm-inline-block">
            <a href="pelunasan.html" class="nav-link">Pelunasan</a>
          </li>
          <li class="nav-item d-none d-sm-inline-block">
            <a href="report.html" class="nav-link">Report</a>
          </li>
        </ul>

        <!-- Right navbar links -->
        <ul class="navbar-nav ml-auto">
          <!-- Update Log Dropdown Menu (menggantikan Notifications) -->
          <li class="nav-item dropdown">
            <a
              class="nav-link"
              data-toggle="dropdown"
              href="#"
              aria-expanded="false"
              id="updateLogToggle"
              title="Update Log"
            >
              <i class="fas fa-history"></i>
              <span id="updateBadge" class="badge badge-info navbar-badge"
                >2</span
              >
            </a>
            <div class="dropdown-menu dropdown-menu-lg dropdown-menu-right p-0">
              <div class="dropdown-header bg-primary text-white py-2 px-3">
                <div class="d-flex justify-content-between align-items-center">
                  <div>
                    <strong>Update Log</strong>
                    <div style="font-size: 0.85rem; opacity: 0.9">
                      Perubahan & perbaikan terbaru
                    </div>
                  </div>
                  <small id="updateLogTime" class="muted">Terbaru</small>
                </div>
              </div>

              <!-- Container untuk items (dirender via JS). class update-dropdown untuk scroll -->
              <div
                id="updateDropdownList"
                class="update-dropdown list-group list-group-flush"
              ></div>

              <div class="dropdown-divider m-0"></div>

              <div class="p-2 text-center">
                <button
                  id="seeAllUpdatesBtn"
                  class="btn btn-sm btn-outline-primary btn-block"
                >
                  Lihat Semua Rincian &nbsp;<i
                    class="fas fa-external-link-alt"
                  ></i>
                </button>
              </div>
            </div>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#" id="logoutBtn" title="Logout">
              <i class="fas fa-sign-out-alt"></i>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" data-widget="fullscreen" href="#" role="button">
              <i class="fas fa-expand-arrows-alt"></i>
            </a>
          </li>
        </ul>
      </nav>
      <!-- /.navbar -->

      <!-- Main Sidebar Container -->
      <aside class="main-sidebar sidebar-dark-primary elevation-4">
        <!-- Brand Logo -->
        <a href="#" class="brand-link">
          <img
            src="../assets/dist/img/AdminLTELogo.png"
            alt="Logo"
            class="brand-image img-circle elevation-3"
            style="opacity: 0.8"
          />
          <span class="brand-text font-weight-light">AppPiutang</span>
        </a>

        <!-- Sidebar -->
        <div class="sidebar">
          <!-- (user panel, search, etc. if perlu) -->

          <!-- Sidebar Menu -->
          <nav class="mt-2">
            <ul
              class="nav nav-pills nav-sidebar flex-column"
              data-widget="treeview"
              role="menu"
              data-accordion="false"
            >
              <!-- Dashboard -->
              <li class="nav-item">
                <a href="../index.html" class="nav-link">
                  <i class="nav-icon fas fa-tachometer-alt"></i>
                  <p>Dashboard</p>
                </a>
              </li>

              <!-- Vendor -->
              <li class="nav-item">
                <a href="vendor.html" class="nav-link">
                  <i class="nav-icon fas fa-store"></i>
                  <p>Vendor</p>
                </a>
              </li>

              <!-- Invoice -->
              <li class="nav-item">
                <a href="invoice.html" class="nav-link">
                  <i class="nav-icon fas fa-file-invoice"></i>
                  <p>Invoice</p>
                </a>
              </li>

              <!-- Pelunasan -->
              <li class="nav-item">
                <a href="pelunasan.html" class="nav-link">
                  <i class="nav-icon fas fa-hand-holding-usd"></i>
                  <p>Pelunasan</p>
                </a>
              </li>

              <!-- Report -->
              <li class="nav-item">
                <a href="report.html" class="nav-link">
                  <i class="nav-icon fas fa-clipboard-list"></i>
                  <p>Report</p>
                </a>
              </li>
            </ul>
          </nav>
          <!-- /.sidebar-menu -->
        </div>
        <!-- /.sidebar -->
      </aside>

      <!-- Content Wrapper. Contains page content -->
      <div class="content-wrapper">
        <!-- Content Header -->
        <section class="content-header">
          <div class="container-fluid">
            <div class="row mb-2">
              <div class="col-sm-6">
                <h1>Vendor</h1>
              </div>
              <div class="col-sm-6">
                <ol class="breadcrumb float-sm-right">
                  <li class="breadcrumb-item">
                    <a href="../index.html">Home</a>
                  </li>
                  <li class="breadcrumb-item active">Vendor</li>
                </ol>
              </div>
            </div>
          </div>
        </section>

        <!-- Main content -->
        <section class="content">
          <!-- Card: Daftar Vendor -->
          <div class="card">
            <div
              class="card-header d-flex justify-content-between align-items-center"
            >
              <h3 class="card-title">Daftar Vendor</h3>
              <!-- Tombol Tambah -->
              <button id="addVendorBtn" class="btn btn-primary">
                <i class="fas fa-plus"></i> Tambah
              </button>
            </div>

            <div class="card-body">
              <!-- Tabel Vendor -->
              <table
                id="vendorTable"
                class="table table-bordered table-striped"
                style="width: 100%"
              >
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>Nama Vendor</th>
                    <th>Aksi</th>
                  </tr>
                </thead>
                <tbody>
                  <!-- Baris-baris data akan diisi via JavaScript -->
                </tbody>
              </table>
            </div>
            <!-- <<< ini overlay spinner AdminLTE >>> -->
            <div id="vendorLoadingOverlay" class="overlay d-none">
              <i class="fas fa-2x fa-sync-alt fa-spin"></i>
            </div>
            <!-- EXTRA LARGE MODAL: Tambah Vendor -->
            <div
              class="modal fade"
              id="modal-add-vendor"
              tabindex="-1"
              aria-labelledby="modalAddVendorLabel"
              aria-hidden="true"
            >
              <div class="modal-dialog modal-xl">
                <div class="modal-content">
                  <form id="formAddVendor">
                    <div class="modal-header">
                      <h5 class="modal-title" id="modalAddVendorLabel">
                        Tambah Vendor
                      </h5>
                      <button
                        type="button"
                        class="close"
                        data-dismiss="modal"
                        aria-label="Close"
                      >
                        <span aria-hidden="true">&times;</span>
                      </button>
                    </div>
                    <div class="modal-body">
                      <!-- Hanya Nama -->
                      <div class="form-group">
                        <label for="vendorNameInput">Nama Vendor</label>
                        <input
                          type="text"
                          class="form-control"
                          id="vendorNameInput"
                          name="nama"
                          placeholder="Masukkan nama vendor"
                        />
                        <small class="text-danger d-none" id="errorVendorName"
                          >Nama Vendor wajib diisi.</small
                        >
                      </div>
                    </div>
                    <div class="modal-footer justify-content-between">
                      <button
                        type="button"
                        class="btn btn-default"
                        data-dismiss="modal"
                      >
                        Batal
                      </button>
                      <button
                        type="submit"
                        class="btn btn-primary"
                        id="btnSaveVendor"
                      >
                        <span id="btnSaveText">Simpan</span>
                        <span
                          id="btnSaveSpinner"
                          class="spinner-border spinner-border-sm d-none"
                          role="status"
                          aria-hidden="true"
                        ></span>
                      </button>
                    </div>
                  </form>
                </div>
              </div>
            </div>
            <!-- EXTRA LARGE MODAL: Edit Vendor -->
            <div
              class="modal fade"
              id="modal-edit-vendor"
              tabindex="-1"
              aria-labelledby="modalEditVendorLabel"
              aria-hidden="true"
            >
              <div class="modal-dialog modal-xl">
                <div class="modal-content">
                  <form id="formEditVendor">
                    <div class="modal-header">
                      <h5 class="modal-title" id="modalEditVendorLabel">
                        Edit Vendor
                      </h5>
                      <button
                        type="button"
                        class="close"
                        data-dismiss="modal"
                        aria-label="Close"
                      >
                        <span aria-hidden="true">&times;</span>
                      </button>
                    </div>
                    <div class="modal-body">
                      <!-- Nama -->
                      <input type="hidden" id="editVendorId" />
                      <div class="form-group">
                        <label for="editVendorName">Nama Vendor</label>
                        <input
                          type="text"
                          class="form-control"
                          id="editVendorName"
                          placeholder="Masukkan nama vendor"
                        />
                        <small
                          class="text-danger d-none"
                          id="errorEditVendorName"
                          >Nama Vendor wajib diisi.</small
                        >
                      </div>
                    </div>
                    <div class="modal-footer justify-content-between">
                      <button
                        type="button"
                        class="btn btn-default"
                        data-dismiss="modal"
                      >
                        Batal
                      </button>
                      <button
                        type="submit"
                        class="btn btn-primary"
                        id="btnEditVendor"
                      >
                        <span id="btnEditText">Simpan</span>
                        <span
                          id="btnEditSpinner"
                          class="spinner-border spinner-border-sm d-none"
                          role="status"
                          aria-hidden="true"
                        ></span>
                      </button>
                    </div>
                  </form>
                </div>
              </div>
            </div>
            <!-- --- Modal: Full Update Log --- -->
            <div
              class="modal fade"
              id="modal-update-log"
              tabindex="-1"
              aria-labelledby="modalUpdateLogLabel"
              aria-hidden="true"
            >
              <div class="modal-dialog modal-lg modal-dialog-centered">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title" id="modalUpdateLogLabel">
                      Rincian Perubahan (Update Log)
                    </h5>
                    <button
                      type="button"
                      class="close"
                      data-dismiss="modal"
                      aria-label="Tutup"
                    >
                      <span aria-hidden="true">&times;</span>
                    </button>
                  </div>
                  <div class="modal-body">
                    <!-- Spinner singkat saat membuka modal -->
                    <div id="updateLogLoading" class="text-center py-3">
                      <div
                        class="spinner-border"
                        role="status"
                        aria-hidden="true"
                      ></div>
                      <div class="mt-2 text-muted">Memuat rincian...</div>
                    </div>

                    <!-- Konten akan dirender via JS ke dalam area ini -->
                    <div id="updateLogContent" class="d-none fade-in-250"></div>
                  </div>
                  <div class="modal-footer">
                    <button
                      type="button"
                      class="btn btn-secondary"
                      data-dismiss="modal"
                    >
                      Tutup
                    </button>
                  </div>
                </div>
              </div>
            </div>
            <!-- END modal update log -->
          </div>
        </section>
        <!-- /.content -->
      </div>
      <!-- /.content-wrapper -->

      <!-- Footer -->
      <footer class="main-footer">
        <div class="float-right d-none d-sm-block"><b>Version</b> 1.1.1</div>
        <strong>&copy; 2025 <a href="#">AppPiutang</a>.</strong> All rights
        reserved.
      </footer>
    </div>
    <!-- ./wrapper -->

    <!-- jQuery -->
    <script src="../assets/plugins/jquery/jquery.min.js"></script>
    <!-- Bootstrap 4 -->
    <script src="../assets/plugins/bootstrap/js/bootstrap.bundle.min.js"></script>
    <!-- AdminLTE App -->
    <script src="../assets/dist/js/adminlte.min.js"></script>
    <!-- SweetAlert2 -->
    <script src="../assets/plugins/sweetalert2/sweetalert2.min.js"></script>
    <!-- Toastr -->
    <script src="../assets/plugins/toastr/toastr.min.js"></script>

    <!-- DataTables  & Plugins -->
    <script src="../assets/plugins/datatables/jquery.dataTables.min.js"></script>
    <script src="../assets/plugins/datatables-bs4/js/dataTables.bootstrap4.min.js"></script>
    <script src="../assets/plugins/datatables-responsive/js/dataTables.responsive.min.js"></script>
    <script src="../assets/plugins/datatables-responsive/js/responsive.bootstrap4.min.js"></script>
    <script src="../assets/plugins/datatables-buttons/js/dataTables.buttons.min.js"></script>
    <script src="../assets/plugins/datatables-buttons/js/buttons.bootstrap4.min.js"></script>
    <script src="../assets/plugins/jszip/jszip.min.js"></script>
    <script src="../assets/plugins/pdfmake/pdfmake.min.js"></script>
    <script src="../assets/plugins/pdfmake/vfs_fonts.js"></script>
    <script src="../assets/plugins/datatables-buttons/js/buttons.html5.min.js"></script>
    <script src="../assets/plugins/datatables-buttons/js/buttons.print.min.js"></script>
    <script src="../assets/plugins/datatables-buttons/js/buttons.colVis.min.js"></script>

    <!-- Script khusus halaman Vendor (dengan action queue) -->
    <script>
      const token = sessionStorage.getItem("authToken");
      const expiry = sessionStorage.getItem("authExpiry");

      if (!token || !expiry || Date.now() > expiry) {
        sessionStorage.clear();
        window.location.href = "lockscreen.html";
      }

      document
        .getElementById("logoutBtn")
        ?.addEventListener("click", function (e) {
          e.preventDefault();
          if (confirm("Yakin mau keluar?")) {
            sessionStorage.clear();
            window.location.href = "lockscreen.html";
          }
        });

      const API_URL =
        "https://script.google.com/macros/s/AKfycbyVnN6XoE6ZYJsAEqLVz5yHOCbGd0Soo425i1W8yu8rxwrWpWcUYEWWp_NwenBW1lIL/exec";

      // Inisialisasi SweetAlert2 Toast (tetap untuk konfirmasi)
      const SwalToast = Swal.mixin({
        toast: true,
        position: "top-end",
        showConfirmButton: false,
        timer: 2500,
      });

      // Toastr config (dipakai untuk queue notifications)
      toastr.options = {
        positionClass: "toast-top-right",
        timeOut: "3000",
      };

      // Utility fetch read with anti-cache
      async function fetchData(table) {
        const res = await fetch(
          `${API_URL}?table=${table}&action=read&_ts=${Date.now()}`
        );
        return await res.json();
      }

      // ------------------ UPDATE LOG DATA (rendered into navbar + modal) ------------------
      // Urutkan dari versi terbaru -> lama
      const updateLogs = [
        {
          version: "V.1.1.1",
          date: "2025-08-26",
          highlight:
            "Menghilangkan pagination pada Invoice Jatuh Tempo & menambahkan halaman Report gabungan Buku Piutang",
          details: [
            "Menghilangkan pagination/halaman pada daftar Invoice Jatuh Tempo di Dashboard agar seluruh item terlihat tanpa pindah halaman — cocok bila Anda ingin melihat semuanya sekilas.",
            "Menambahkan halaman Report baru yang mengumpulkan seluruh data Buku Piutang ke dalam satu tabel sehingga memudahkan ekspor/analisis.",
            "Perbaikan kecil: tata letak dan konsistensi tombol pada halaman Report.",
          ],
        },
        {
          version: "V.1.0.1",
          date: "2025-08-16",
          highlight:
            "Kolom baru untuk diskon & pajak, input nilai manual, urutan list terbaru di atas, pembulatan subtotal, dan perbaikan bug",
          details: [
            "Menambahkan kolom: Nilai Diskon, Pajak %, dan Nilai Pajak sehingga perhitungan invoice lebih jelas.",
            "Nilai Diskon dan Nilai Pajak sekarang bisa diisi langsung secara manual tanpa harus mengisi persentasenya terlebih dulu — gampang kalau Anda sudah tahu nominalnya.",
            "Daftar Invoice dan Vendor kini menampilkan item yang baru ditambahkan di bagian paling atas agar mudah terlihat.",
            "Pengecekan error jumlah subtotal semua produk terhadap total invoice sekarang menerapkan aturan pembulatan sehingga mengurangi mismatch kecil karena desimal.",
            "Perbaikan beberapa error / bug kecil sehingga pengalaman lebih stabil.",
          ],
        },
      ];

      // Renders brief list in dropdown and sets badge count
      function renderUpdateDropdown() {
        const $list = $("#updateDropdownList");
        $list.empty();
        updateLogs.forEach((u) => {
          const item = $(`
            <a href="#" class="list-group-item list-group-item-action update-item" data-version="${u.version}">
              <div class="d-flex w-100 justify-content-between">
                <div>
                  <div class="version">${u.version}</div>
                  <div class="muted">${u.date} &middot; ${u.highlight}</div>
                </div>
                <small class="text-primary align-self-start"><i class="fas fa-chevron-right"></i></small>
              </div>
            </a>
          `);
          $list.append(item);
        });

        // update badge
        $("#updateBadge").text(updateLogs.length);

        // set header time (terbaru)
        if (updateLogs.length) {
          $("#updateLogTime").text("Terbaru: " + updateLogs[0].date);
        }
      }

      // Renders full details into modal
      function renderUpdateModal(version) {
        const u = updateLogs.find((x) => x.version === version);
        const $content = $("#updateLogContent");
        $content.empty();

        if (!u) {
          $content.append("<p>Tidak ada rincian untuk versi ini.</p>");
          return;
        }

        const $html = $(`
          <div>
            <h5>${u.version} <small class="text-muted">(${u.date})</small></h5>
            <p class="text-muted">${u.highlight}</p>
            <ul></ul>
          </div>
        `);
        u.details.forEach((d) => {
          $html.find("ul").append(`<li>${d}</li>`);
        });

        // tambahan: saran singkat untuk pengguna awam (bahasa sederhana)
        $html.append(
          `<hr><p class="mb-0 text-muted small">Catatan singkat: jika Anda menggunakan fitur Invoice atau Report, silakan cek tata-letak kolom baru untuk diskon/pajak. Jika menemukan sesuatu yang aneh, hubungi tim IT / support.</p>`
        );

        $content.append($html);
      }

      // handle click on an item -> open modal with details (with short loading animation)
      $(document).on("click", ".update-item", function (e) {
        e.preventDefault();
        const version = $(this).data("version");
        $("#modal-update-log").modal("show");
        // show spinner, hide content
        $("#updateLogContent").addClass("d-none").empty();
        $("#updateLogLoading").show();

        // simulate small loading to make UX smoother (200-400ms)
        setTimeout(function () {
          renderUpdateModal(version);
          $("#updateLogLoading").hide();
          $("#updateLogContent").removeClass("d-none");
        }, 280);
      });

      // "Lihat Semua Rincian" button -> show modal with full list (newest first)
      $("#seeAllUpdatesBtn").on("click", function () {
        $("#modal-update-log").modal("show");
        $("#updateLogContent").addClass("d-none").empty();
        $("#updateLogLoading").show();

        setTimeout(function () {
          // render all versions in modal
          const $content = $("#updateLogContent");
          updateLogs.forEach((u) => {
            const $block = $(`
              <div class="mb-3">
                <h5>${u.version} <small class="text-muted">(${u.date})</small></h5>
                <p class="text-muted">${u.highlight}</p>
                <ul></ul>
              </div>
            `);
            u.details.forEach((d) => $block.find("ul").append(`<li>${d}</li>`));
            $content.append($block);
          });
          $content.append(
            `<hr><p class="text-muted small mb-0">Terakhir diperbarui: ${updateLogs[0].date}</p>`
          );
          $("#updateLogLoading").hide();
          $content.removeClass("d-none");
        }, 350);
      });

      // On dropdown open, if the list is taller than threshold, show hint to open modal
      $(document).on("shown.bs.dropdown", "#updateLogToggle", function () {
        const $list = $("#updateDropdownList");
        // if scroll height is large, ensure user can open modal
        if ($list.prop("scrollHeight") > 240) {
          // optional: flash the "See All" button briefly
          $("#seeAllUpdatesBtn").addClass("btn-outline-success");
          setTimeout(
            () => $("#seeAllUpdatesBtn").removeClass("btn-outline-success"),
            700
          );
        }
      });

      // Init render
      $(function () {
        renderUpdateDropdown();
      });

      function setActiveMenuForVendorPage() {
        // hapus active pada semua nav-link dulu
        document
          .querySelectorAll(".nav-link")
          .forEach((a) => a.classList.remove("active"));

        // aktifkan link yang mengarah ke vendor.html
        const anchors = Array.from(document.querySelectorAll("a.nav-link"));
        anchors.forEach((a) => {
          try {
            const href = a.getAttribute("href") || "";
            if (href.endsWith("vendor.html") || href === "vendor.html") {
              a.classList.add("active");
              // jika ada parent li, beri juga class active/menu-open (safe)
              const li = a.closest(".nav-item");
              if (li) li.classList.add("menu-open");
            }
          } catch (e) {
            /* ignore */
          }
        });

        // juga coba beri active pada top navbar (jika ada link yang cocok)
        const topNav = Array.from(document.querySelectorAll(".navbar-nav a"));
        topNav.forEach((a) => {
          const href = a.getAttribute("href") || "";
          if (href.endsWith("vendor.html")) a.classList.add("active");
        });
      }

      async function retryFetch(url, options = {}, retries = 3, delayMs = 500) {
        for (let i = 0; i < retries; i++) {
          try {
            const res = await fetch(url, options);
            if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
            return await res.json();
          } catch (err) {
            if (i === retries - 1) throw err; // terakhir gagal, lempar error
            await new Promise((r) => setTimeout(r, delayMs)); // delay sebelum retry
          }
        }
      }

      async function getNextVendorId() {
        const url = `${API_URL}?table=vendors&action=get_next_id`;
        try {
          const data = await retryFetch(url, {}, 3, 500);
          if (!data.next_id || isNaN(data.next_id))
            throw new Error("Invalid next_id");
          return data.next_id;
        } catch (err) {
          console.error("Gagal hitung next ID setelah retry:", err);
          return Date.now(); // fallback paling aman, jangan null
        }
      }

      // ----------------- Action Queue (sama pola dengan halaman lain) -----------------
      let actionQueue = [];
      let refreshTimer = null;
      let refreshDelay = 5000; // 5 detik setelah semua aksi selesai

      function addActionToQueue(description, processFn) {
        const actionId =
          Date.now() + "-" + Math.random().toString(36).substring(2, 7);

        // Tambahkan ke queue
        actionQueue.push({
          id: actionId,
          description,
          status: "pending",
        });

        // Tampilkan toastr untuk pending (tidak auto-close)
        toastr.info(description + " (sedang diproses...)", "Proses", {
          timeOut: 5000,
          extendedTimeOut: 5000,
        });

        // Jalankan proses async
        processFn()
          .then(() => updateActionStatus(actionId, "success"))
          .catch(() => updateActionStatus(actionId, "error"));
      }

      function updateActionStatus(id, status) {
        const action = actionQueue.find((a) => a.id === id);
        if (!action) return;

        action.status = status;

        // Update toastr sesuai status
        if (status === "success") {
          toastr.success(action.description + " berhasil", "Selesai");
        } else if (status === "error") {
          toastr.error(action.description + " gagal", "Error");
        }

        checkQueueCompletion();
      }

      function isAnyModalOpen() {
        return document.querySelectorAll(".modal.show").length > 0;
      }

      function checkQueueCompletion() {
        const allDone = actionQueue.every((a) => a.status !== "pending");

        if (allDone) {
          // Jadwalkan refresh
          if (refreshTimer) clearTimeout(refreshTimer);
          refreshTimer = setTimeout(tryRefreshVendors, refreshDelay);
        }
      }

      function tryRefreshVendors() {
        if (!isAnyModalOpen()) {
          loadVendors();
          actionQueue = []; // kosongkan queue setelah refresh
        } else {
          // Tunggu lagi 5 detik jika user masih aktif di modal
          refreshTimer = setTimeout(tryRefreshVendors, 5000);
        }
      }

      // ----------------- UI: add / edit / delete menggunakan queue -----------------

      // Show modal saat tombol Tambah diklik
      document.getElementById("addVendorBtn").addEventListener("click", () => {
        document.getElementById("formAddVendor").reset();
        document.getElementById("errorVendorName").classList.add("d-none");
        $("#modal-add-vendor").modal("show");
      });

      // Submit handler untuk form Tambah Vendor (menggunakan queue)
      document
        .getElementById("formAddVendor")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const nameVal = document
            .getElementById("vendorNameInput")
            .value.trim();
          let hasError = false;
          document.getElementById("errorVendorName").classList.add("d-none");

          // Validasi nama
          if (!nameVal) {
            document.getElementById("errorVendorName").textContent =
              "Nama Vendor wajib diisi.";
            document
              .getElementById("errorVendorName")
              .classList.remove("d-none");
            hasError = true;
          }
          if (hasError) return;

          // Disable tombol submit sementara (prevent double click while preparing)
          const btnSubmit = e.target.querySelector("button[type=submit]");
          const btnText = document.getElementById("btnSaveText");
          const btnSpinner = document.getElementById("btnSaveSpinner");
          btnSubmit.setAttribute("disabled", "disabled");
          btnText.textContent = "Menyimpan...";
          btnSpinner.classList.remove("d-none");

          // Dapatkan nextId
          const nextId = await getNextVendorId();
          if (!nextId) {
            toastr.error("Gagal menentukan ID vendor", "Error");
            btnSubmit.removeAttribute("disabled");
            btnText.textContent = "Simpan";
            btnSpinner.classList.add("d-none");
            return;
          }

          // Tutup modal segera (ikuti pola Anda)
          $("#modal-add-vendor").modal("hide");

          // Tambahkan proses ke queue
          addActionToQueue("Menambahkan vendor", async () => {
            try {
              // coba kirim POST (bisa gagal CORS)
              await fetch(
                `${API_URL}?table=vendors&action=create&id=${nextId}&nama=${encodeURIComponent(
                  nameVal
                )}`,
                { method: "POST" }
              );
            } catch (err) {
              console.warn("POST create vendor mungkin gagal (CORS).", err);
            }

            // Verifikasi manual: cari id baru
            for (let attempt = 0; attempt < 3; attempt++) {
              try {
                const all = await fetchData("vendors");
                if (all.find((v) => String(v.id) === String(nextId))) {
                  return Promise.resolve();
                }
              } catch (err) {
                console.warn("Verifikasi create vendor gagal, coba lagi", err);
              }
              await new Promise((r) => setTimeout(r, 1000));
            }
            return Promise.reject(new Error("Vendor baru tidak ditemukan."));
          });

          // reset button UI
          btnSubmit.removeAttribute("disabled");
          btnText.textContent = "Simpan";
          btnSpinner.classList.add("d-none");
        });

      // Fill and open edit modal
      function openEditVendorModal(vendor) {
        document.getElementById("editVendorId").value = vendor.id;
        document.getElementById("editVendorName").value = vendor.nama;
        document.getElementById("errorEditVendorName").classList.add("d-none");
        $("#modal-edit-vendor").modal("show");
      }

      // Submit handler Edit (pakai queue)
      document
        .getElementById("formEditVendor")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const idVal = document.getElementById("editVendorId").value;
          const nameVal = document
            .getElementById("editVendorName")
            .value.trim();

          if (!nameVal) {
            document.getElementById("errorEditVendorName").textContent =
              "Nama Vendor wajib diisi.";
            document
              .getElementById("errorEditVendorName")
              .classList.remove("d-none");
            return;
          }

          // Disable tombol sementara
          const btnSubmit = e.target.querySelector("button[type=submit]");
          const btnText = document.getElementById("btnEditText");
          const btnSpinner = document.getElementById("btnEditSpinner");
          btnSubmit.setAttribute("disabled", "disabled");
          btnText.textContent = "Menyimpan...";
          btnSpinner.classList.remove("d-none");

          // Tutup modal segera
          $("#modal-edit-vendor").modal("hide");

          // Masukkan proses update ke queue
          addActionToQueue("Memperbarui vendor", async () => {
            try {
              await fetch(
                `${API_URL}?table=vendors&action=update&id=${encodeURIComponent(
                  idVal
                )}&nama=${encodeURIComponent(nameVal)}`,
                { method: "POST" }
              );
            } catch (err) {
              console.warn("POST update vendor mungkin gagal (CORS).", err);
            }

            // verifikasi manual
            for (let attempt = 0; attempt < 3; attempt++) {
              try {
                const all = await fetchData("vendors");
                const found = all.find(
                  (v) =>
                    String(v.id) === String(idVal) &&
                    String(v.nama || "") === String(nameVal)
                );
                if (found) return Promise.resolve();
              } catch (err) {
                console.warn("Verifikasi update vendor gagal, coba lagi", err);
              }
              await new Promise((r) => setTimeout(r, 1000));
            }
            return Promise.reject(new Error("Gagal memperbarui vendor"));
          });

          // reset button UI
          btnSubmit.removeAttribute("disabled");
          btnText.textContent = "Simpan";
          btnSpinner.classList.add("d-none");
        });

      // Delete (gunakan queue)
      async function handleDeleteVendor(vendorId) {
        const result = await Swal.fire({
          title: "Yakin ingin menghapus vendor ini?",
          icon: "warning",
          showCancelButton: true,
          confirmButtonText: "Ya, Hapus!",
          cancelButtonText: "Batal",
        });

        if (!result.isConfirmed) return;

        addActionToQueue("Menghapus vendor", async () => {
          try {
            // langsung kirim delete
            await fetch(
              `${API_URL}?table=vendors&action=delete&id=${encodeURIComponent(
                vendorId
              )}`,
              { method: "POST" }
            );
          } catch (err) {
            console.warn("POST delete vendor mungkin gagal (CORS).", err);
          }

          // verifikasi manual: vendor harus hilang
          for (let attempt = 0; attempt < 3; attempt++) {
            try {
              const all = await fetchData("vendors");
              if (!all.find((v) => String(v.id) === String(vendorId))) {
                return Promise.resolve();
              }
            } catch (err) {
              console.warn("Verifikasi delete vendor gagal, coba lagi", err);
            }
            await new Promise((r) => setTimeout(r, 1000));
          }
          return Promise.reject(new Error("Gagal menghapus vendor"));
        });
      }

      // ----------------- Load vendors & setup actions -----------------
      let vendorDataTable = null;

      function getFormattedTimestamp() {
        const now = new Date();
        return now.toLocaleString("id-ID", {
          day: "2-digit",
          month: "short",
          year: "numeric",
          hour: "2-digit",
          minute: "2-digit",
          second: "2-digit",
        });
      }

      // global cache
      let cachedVendors = [];

      async function loadVendors() {
        setLoading(true);
        try {
          const res = await fetch(`${API_URL}?table=vendors&action=read`);
          const vendors = await res.json();

          // simpan cache supaya modal edit tidak perlu fetch lagi
          cachedVendors = vendors;

          // Hapus dan inisialisasi ulang DataTable untuk refresh data
          if (vendorDataTable) {
            vendorDataTable.clear().destroy();
          }

          const tbody = document.querySelector("#vendorTable tbody");
          tbody.innerHTML = "";

          function sortByIdDesc(arr) {
            return [...arr].sort((a, b) => {
              const ai = parseInt(a.id, 10);
              const bi = parseInt(b.id, 10);

              if (!isNaN(ai) && !isNaN(bi)) {
                return bi - ai; // numeric compare
              }

              // fallback: localeCompare with numeric option (handles "10" > "2" correctly)
              const sa = (a.id ?? "").toString();
              const sb = (b.id ?? "").toString();
              return sb.localeCompare(sa, undefined, {
                numeric: true,
                sensitivity: "base",
              });
            });
          }

          const sortedVendors = sortByIdDesc(vendors);

          sortedVendors.forEach((v, idx) => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td>${idx + 1}</td>
              <td>${v.nama}</td>
              <td>
                <button class="btn btn-sm btn-info btn-edit" data-id="${v.id}">
                  <i class="fas fa-edit"></i>
                </button>
                <button class="btn btn-sm btn-danger btn-delete" data-id="${
                  v.id
                }">
                  <i class="fas fa-trash-alt"></i>
                </button>
              </td>
            `;
            tbody.appendChild(tr);
          });

          // Inisialisasi DataTable ulang
          vendorDataTable = $("#vendorTable").DataTable({
            responsive: true,
            lengthChange: true,
            lengthMenu: [
              [10, 25, 50, 100],
              [10, 25, 50, 100],
            ],
            autoWidth: false,
            order: [],
            buttons: [
              {
                extend: "copy",
                title: "Master Data Vendor",
                messageTop: "Dimuat pada: " + getFormattedTimestamp(),
                exportOptions: {
                  columns: ":not(:last-child)",
                },
              },
              {
                extend: "csv",
                title: "Master Data Vendor",
                exportOptions: {
                  columns: ":not(:last-child)",
                },
              },
              {
                extend: "excel",
                title: "Master Data Vendor",
                messageTop: "Dimuat pada: " + getFormattedTimestamp(),
                exportOptions: {
                  columns: ":not(:last-child)",
                },
              },
              {
                extend: "pdf",
                title: "Master Data Vendor",
                messageTop: "Dimuat pada: " + getFormattedTimestamp(),
                exportOptions: {
                  columns: ":not(:last-child)",
                },
              },
              {
                extend: "print",
                title: "Master Data Vendor",
                messageTop: "Dimuat pada: " + getFormattedTimestamp(),
                exportOptions: {
                  columns: ":not(:last-child)",
                },
              },
              "colvis",
            ],
          });

          // Tempelkan tombol-tombol DataTable
          vendorDataTable
            .buttons()
            .container()
            .appendTo("#vendorTable_wrapper .col-md-6:eq(0)");

          // Pasang listener untuk tombol aksi (edit / delete)
          // Gunakan event delegation untuk mencegah double-binding
          const vendorTbody = document.querySelector("#vendorTable tbody");
          if (vendorTbody) {
            vendorTbody.addEventListener("click", function (e) {
              const btn = e.target.closest(".btn-edit, .btn-delete");
              if (!btn) return;

              const id = btn.dataset.id;
              if (btn.classList.contains("btn-edit")) {
                const vendor = cachedVendors.find(
                  (v) => String(v.id) === String(id)
                );
                if (vendor) {
                  openEditVendorModal(vendor);
                } else {
                  // fallback: ambil dari server jika cache belum siap
                  (async () => {
                    try {
                      const all = await fetchData("vendors");
                      const v = all.find((x) => String(x.id) === String(id));
                      if (v) openEditVendorModal(v);
                    } catch (err) {
                      console.warn("Gagal ambil vendor fallback", err);
                    }
                  })();
                }
              } else if (btn.classList.contains("btn-delete")) {
                handleDeleteVendor(id);
              }
            });
          }
        } catch (err) {
          console.error("Error load vendors:", err);
          toastr.error("Gagal memuat data vendor", "Error");
        } finally {
          setLoading(false);
        }
      }

      // Utility: toggle spinner overlay loading
      function setLoading(isLoading) {
        const overlay = document.getElementById("vendorLoadingOverlay");
        overlay.classList.toggle("d-none", !isLoading);
      }

      // Initial load
      document.addEventListener("DOMContentLoaded", () => {
        loadVendors();
        setActiveMenuForVendorPage();
      });
    </script>
  </body>
</html>
